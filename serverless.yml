useDotenv: true

service: openai-api-apps
frameworkVersion: "3"
provider:
  name: aws
  stage: dev
  region: ap-northeast-1
  runtime: nodejs18.x

custom:
  definitions:
    authorizer:
      name: authorizer
      resultTtlInSeconds: 0
      identitySource: method.request.header.Authorization
      type: request

package:
  patterns:
    - "!**"
    - ".output/**"
    - "infra/functions/authorizer.js"

functions:
  NuxtSsrEngine:
    handler: ".output/server/index.handler"
    environment:
      DB_URL: ${env:DB_URL}
    events:
      - http:
          method: any
          path: /
          authorizer: ${self:custom.definitions.authorizer}

      - http:
          method: any
          path: /{proxy+}
          authorizer: ${self:custom.definitions.authorizer}
  authorizer:
    handler: "infra/functions/authorizer.handler"
    environment:
      AUTH_USERNAME: ${env:AUTH_USERNAME}
      AUTH_PASSWORD: ${env:AUTH_PASSWORD}

resources:
  Resources:
    GatewayResponse:
      Type: "AWS::ApiGateway::GatewayResponse"
      Properties:
        ResponseParameters:
          gatewayresponse.header.WWW-Authenticate: "'Basic'"
        ResponseType: UNAUTHORIZED
        RestApiId:
          Ref: "ApiGatewayRestApi"
        StatusCode: "401"
